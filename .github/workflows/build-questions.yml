name: Build questions.json

on:
  push:
    paths:
      - 'images/**'
      - 'data/**'              # includes answers_min.csv, answers.csv, etc.
      - 'tools/**'
      - 'index.html'
      - 'sw.js'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    # Prevent loops when this workflow commits "Auto: rebuild..."
    if: ${{ !contains(github.event.head_commit.message, 'Auto: rebuild questions') }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 1) Build questions.json from your images/CSVs
      - name: Build questions.json
        run: node tools/build-questions.mjs

      # 2) Cache-bust: stamp commit SHA into sw.js + questions.json URL in index.html
      - name: Stamp cache/version
        shell: bash
        run: |
          set -e
          SHA=${GITHUB_SHA::7}

          # Update SHELL_CACHE in sw.js (handles single/double quotes)
          if [ -f sw.js ]; then
            sed -E -i "s/(const[[:space:]]+SHELL_CACHE[[:space:]]*=[[:space:]]*['\"])exam-shell-v[0-9A-Za-z_-]+(['\"])/\1exam-shell-v${SHA}\2/" sw.js || true
          fi

          # Update ?v= on questions.json in index.html to force fresh fetch
          if [ -f index.html ]; then
            sed -E -i "s#questions.json\\?v=[0-9A-Za-z._-]+#questions.json?v=${SHA}#g" index.html
          fi

      # 3) Commit the generated/updated files
      - name: Commit updates
        run: |
          SHA=${GITHUB_SHA::7}
          git config user.name  "github-actions"
          git config user.email "actions@github.com"
          git add questions.json index.html sw.js
          git commit -m "Auto: rebuild questions + cache-bust ${SHA}" || echo "No changes"
          git push
